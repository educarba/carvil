<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot con Envío de Archivos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      max-width: 600px;
      margin: auto;
      background: #fff;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message-line {
      margin: 5px 0;
    }
    .message-line.user {
      text-align: right;
      color: blue;
    }
    .message-line.bot {
      text-align: left;
      color: green;
    }
    #input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      gap: 5px;
    }
    #input-area input[type="text"] {
      flex: 1;
      padding: 8px;
    }
    #input-area input[type="file"] {
      flex: 1;
    }
    #input-area button {
      padding: 8px 12px;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="Escribe tu mensaje...">
      <input type="file" id="file-upload">
      <button id="send-btn">Enviar</button>
    </div>
  </div>

  <script>
    const messagesContainer = document.getElementById('messages');
    const inputField = document.getElementById('user-input');
    const fileUpload = document.getElementById('file-upload');
    const sendBtn = document.getElementById('send-btn');

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.classList.add('message-line', sender);
      div.textContent = text;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function renderBotResponse(data) {
      if (data && data.reply) {
        addMessage(data.reply, 'bot');
      } else {
        addMessage('Respuesta recibida (sin formato)', 'bot');
      }
    }

    async function sendMessage(customText) {
      const text = customText || inputField.value.trim();
      const file = fileUpload.files[0];

      if (!text && !file) return;

      if (text) addMessage(text, 'user');
      if (file) addMessage("Archivo enviado: " + file.name, 'user');

      inputField.value = '';
      fileUpload.value = '';

      const typing = document.createElement('div');
      typing.classList.add('message-line');
      typing.innerHTML = '<em>Bot escribiendo...</em>';
      messagesContainer.appendChild(typing);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      try {
        let res;
        if (file) {
          // Envío con archivo
          const formData = new FormData();
          formData.append('file', file); // En n8n estará en $binary.file
          if (text) formData.append('message', text);

          res = await fetch('https://warming-potential-filled-attended.trycloudflare.com/webhook/agente', {
            method: 'POST',
            body: formData
          });
        } else {
          // Envío solo texto
          res = await fetch('https://warming-potential-filled-attended.trycloudflare.com/webhook/agente', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });
        }

        const data = await res.json();
        messagesContainer.removeChild(typing);
        renderBotResponse(data);

      } catch (e) {
        messagesContainer.removeChild(typing);
        addMessage('Error de conexión', 'bot');
        console.error(e);
      }
    }

    sendBtn.addEventListener('click', () => sendMessage());
    inputField.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
